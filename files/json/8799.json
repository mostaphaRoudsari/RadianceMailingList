{"body": "\nAll this talk of Radiance skies made me remember that I recently\nimplemented part of Preetham, Shirley, Smits, \"A Practical,\nAnalytical Model for Daylight\" for Radiance. It's rough around\nthe edges, but produces good (if not totally accurate) results.\n\nSpecifically, I modeled the part that determines the sky color\nand brightness, not the part that determines the color shift for\nfaraway objects due to atmospheric scattering (maybe I'll have\nthat done by the Radiance User Conference this year).\n\nTo use it, first run gensky (as normal), but comment out the\nbrightfunc description and add a new colorfunc entry. The real\narguments are turbidity and sun direction (copy the last 3\nentries from the brightfunc line), like this example for a sky\nafter sunset:\n\n#void brightfunc skyfunc\n#2 skybr skybright.cal\n#0\n#7 1 9.75e-01 4.02e-01 2.68e-01 -0.918161 0.378882 -0.115887\n\nvoid colorfunc skyfunc\n4 skyr skyg skyb utah.cal\n0\n4 2. -0.918161 0.378882 -0.115887\n\nLike gensky, to use it attach it to a glow source:\n\nskyfunc glow skydome\n0 0 4  1. 1. 1. 0\nskydome source sky\n0 0 4  0 0 1  180\nskydome source sky2\n0 0 4  0 0 -1  180\n\nSo, for the sample scene file attached, run:\n\n% oconv duskscene.rad > duskscene.oct\n% rvu -vp 1 -5 2 -vd -1 5 -1.5 -vh 90 -vv 90 -ab 2 -ad 512 -ar\n512 -as 128 -aa 0.1 -pe -5 duskscene.oct\n\nIt isn't quite automatic yet, and it does emit some errors,\nthough I hope to clean those up soon.\n\nWould this be most useful as a command-line option to gensky? It\nwould seem most applicable there. Plus, that would allow control\nover the sun color, which shifts subtly from white to orange-ish\nnearer the horizons.\n\nEnjoy.\n\nMark\nmstock@umich.edu\n-------------- next part --------------\n# gensky 08 18 19.5\n# Local solar time: 19.30\n# Solar altitude and azimuth: -6.7 112.4\n# Ground ambient level: 2.0\n\n#void brightfunc skyfunc\n#2 skybr skybright.cal\n#0\n#7 1 9.75e-01 4.02e-01 2.68e-01 -0.918161 0.378882 -0.115887\n\nvoid colorfunc skyfunc\n4 skyr skyg skyb utah.cal\n0\n4 2. -0.918161 0.378882 -0.115887\n\nskyfunc glow skydome\n0 0 4  1. 1. 1. 0\n\nskydome source sky\n0 0 4  0 0 1  180\nskydome source sky2\n0 0 4  0 0 -1  180\n\n\nvoid plastic groundc 0 0 5  0.5 0.4 0.24 0.0 0.0\ngroundc ring ground 0 0 8  0 0 0  0 0 1  0 20\n\nvoid plastic grey 0 0 5  0.18 0.18 0.18 0 0\n!genbox grey box 1 1 1 -r 0.02 | xform -t -0.5 -0.5 0\n-------------- next part --------------\n{\npreetham.cal - Sky color function for Radiance skies, meant\nto work in place of skybright.cal\n\nFrom Preetham, Shirley, Smits, \"A Practical, Analytical Model for Daylight\"\n\nConverted to Radiance by Mark J. Stock, mstock@umich.edu\n\nA1\t\t\t- Turbidity\nA2,A3,A4\t\t- sun direction\n\nAn example usage for a late afternoon sky follows:\n(run gensky 4 30 16.2 -a 42 +s to create the following text)\n\n# gensky 4 30 16.2 -a 42 +s\n# Local solar time: 16.11\n# Solar altitude and azimuth: 30.6 81.9\n# Ground ambient level: 15.4\n\nvoid light solar\n0\n0\n3 6.19e+06 6.19e+06 6.19e+06\n\nsolar source sun\n0\n0\n4 -0.852270 -0.121498 0.508797 0.5\n\n#void brightfunc skyfunc\n#2 skybr skybright.cal\n#0\n#7 1 7.62e+00 1.51e+01 4.03e-01 -0.852270 -0.121498 0.508797\n# notice how I stole this line for skycolor below?\n\nvoid colorfunc skyfunc\n4 skyr skyg skyb utah.cal\n0\n4 2. -0.852270 -0.121498 0.508797\n\nskyfunc glow sky_glow\n0\n0\n4 1.0 1.0 1.0 0\n\nsky_glow source sky\n0\n0\n4 0 0 1 180\n\n}\n\n{ perez(theta, gamma, a, b, c, d, e) = (1.+a*exp(b/cos(theta))) * (1+c*exp(d*gamma)+e*cos(gamma)*cos(gamma)); }\nperez(t, g, a, b, c, d, e) = (1.+a*exp(b/(0.0001+abs(cos(t))))) * (1+c*exp(d*g)+e*cos(g)*cos(g));\n\ncosgamma = Dx*A2 + Dy*A3 + Dz*A4;\ngamma = Acos(cosgamma);\t\t{ angle from sun to this point in sky }\ntheta = Acos(Dz);\t\t{ angle from zenith to this point in sky }\nthetas = Acos(A4);\t\t{ angle from zenith to sun }\n\n{ zenith brightness, chromaticity }\nyyz = (4.0453*A1 - 4.971)*tan((0.4444-A1/120.)*(3.1415927-2*thetas)) - 0.2155*A1 + 2.4192;\nxz = 0.25886 + 0.00394*A1 + thetas*(0.06052 - 0.03202*A1*(1.-0.065272*A1) + thetas*(-0.21196 + 0.06377*A1*(1.-0.058805*A1) + thetas*(0.11693 - 0.02903*A1*(1.-0.057182*A1))));\nyz = 0.26688 + 0.00516*A1 + thetas*(0.0667 - 0.04153*A1*(1.-0.07633*A1) + thetas*(-0.26756 + 0.0897*A1*(1.-0.068004*A1) + thetas*(0.15346 - 0.04214*A1*(1.-0.065259*A1))));\n\n{ distribution coefficients for luminance, chromaticity; functions of turbidity }\nayy = 0.1787*A1 - 1.463;\nbyy = -0.3554*A1 + 0.4275;\ncyy = -0.0227*A1 + 5.3251;\ndyy = 0.1206*A1 - 2.5771;\neyy = -0.067*A1 + 0.3703;\n\nax = -0.0193*A1 - 0.2593;\nbx = -0.0665*A1 + 0.0008;\ncx = -0.0004*A1 + 0.2125;\ndx = -0.0641*A1 - 0.8989;\nex = -0.0033*A1 + 0.0452;\n\nay = -0.0167*A1 - 0.2608;\nby = -0.095*A1 + 0.0092;\ncy = -0.0079*A1 + 0.2102;\ndy = -0.0441*A1 - 1.6537;\ney = -0.0109*A1 + 0.0529;\n\n{ point values for luminance, chromaticity }\nyyp = yyz * perez(theta, gamma, ayy, byy, cyy, dyy, eyy) / perez(0., thetas, ayy, byy, cyy, dyy, eyy);\nxp = xz * perez(theta, gamma, ax, bx, cx, dx, ex) / perez(0., thetas, ax, bx, cx, dx, ex);\nyp = yz * perez(theta, gamma, ay, by, cy, dy, ey) / perez(0., thetas, ay, by, cy, dy, ey);\n\n{ output brightness }\nskybr = yyp;\n\n{ output radiance }\n\n{ first, tristimulus values }\nx = yyp*xp/yp;\ny = yyp;\n{z = yyp*(1.-xp-yp)/yp;}\nz = yyp*if(1.-xp-yp, 1-xp-yp, 0.)/yp;\n\n{ convert using CIE M^-1 matrix from http://www.brucelindbloom.com/Eqn_RGB_XYZ_Matrix.html }\n{ do not apply gamma, as we are in linear units }\nskyr = 2.3706743*x - 0.9000405*y - 0.4706338*z;\nskyg = -0.513885*x + 1.4253036*y + 0.0885814*z;\nskyb = 0.0052982*x - 0.0146949*y + 1.0093968*z;\n{r = 2.3706743*x - 0.9000405*y - 0.4706338*z;\ng = -0.513885*x + 1.4253036*y + 0.0885814*z;\nb = 0.0052982*x - 0.0146949*y + 1.0093968*z;\n\nskyr = if(r, r, 0.);\nskyg = if(g, g, 0.);\nskyb = if(b, b, 0.);}\n", "replyTo": "", "sender": "Mark Stock", "isquestion": true, "tags": [], "id": "<Pine.LNX.4.64.0908120857050.2865@rygar.gpcc.itd.umich.edu>", "refs": [], "datetime": "Wed Aug 12 06:17:53 2009", "email": "mstock at umich.edu", "subject": "[Radiance-general] Utah sky model .cal file"}