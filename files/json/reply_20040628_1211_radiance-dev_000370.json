{"body": "Hi Mark,\n\n\nCarsten was right.  There was an accumulation of numerical error in the \ncone normal computation for needle-like cones like yours.  The errors I \nsaw were as high as 10^-3, which is significant and can accumulate \nespecially on multiple ray intersections.  I have added a correction \nthat should take care of this, which I have attached as a context diff, \nbelow.\n\n\n-Greg\n\n\nIndex: o_cone.c\n\n\nRCS file: /cvs/radiance//ray/src/rt/o_cone.c,v\nretrieving revision 2.5\nretrieving revision 2.6\ndiff -r2.5 -r2.6\n2c2\n< static const char RCSid[] = \"$Id: o_cone.c,v 2.5 2004/03/30 16:13:01 \nschorsch Exp $\";\n\n\n > static const char RCSid[] = \"$Id: o_cone.c,v 2.6 2004/06/28 10:07:17 \ngreg Exp $\";\n129a130,134\n >               a = DOT(r->ron, r->ron);\n >               if (a > 1.+FTINY || a < 1.-FTINY) {\n >                       c = 1./(.5 + .5*a);     /* avoid numerical \nerror */\n >                       r->ron[0] *= c; r->ron[1] *= c; r->ron[2] *= c;\n >               }\n[photon:ray/src/rt] gward% ^diff^diff -c\ncvs diff -c -r 2.5 o_cone.c\nEnter passphrase for key '/Users/gward/.ssh/id_rsa':\nIndex: o_cone.c\n\n\nRCS file: /cvs/radiance//ray/src/rt/o_cone.c,v\nretrieving revision 2.5\nretrieving revision 2.6\ndiff -c -r2.5 -r2.6\n*** a/o_cone.c  30 Mar 2004 16:13:01 -0000      2.5\n--- b/o_cone.c  28 Jun 2004 10:07:17 -0000      2.6\n***************\n*** 1,5 ****\n   #ifndef lint\n! static const char RCSid[] = \"$Id: o_cone.c,v 2.5 2004/03/30 16:13:01 \nschorsch Exp $\";\n   #endif\n   /*\n    *  o_cone.c - routine to determine ray intersection with cones.\n--- 1,5 ----\n   #ifndef lint\n! static const char RCSid[] = \"$Id: o_cone.c,v 2.6 2004/06/28 10:07:17 \ngreg Exp $\";\n   #endif\n   /*\n    *  o_cone.c - routine to determine ray intersection with cones.\n***************\n*** 127,132 ****\n--- 127,137 ----\n                         for (i = 0; i < 3; i++)\n                                 r->ron[i] = (co->al*r->ron[i] - \nc*co->ad[i])\n                                                 /co->sl;\n+               a = DOT(r->ron, r->ron);\n+               if (a > 1.+FTINY || a < 1.-FTINY) {\n+                       c = 1./(.5 + .5*a);     /* avoid numerical \nerror */\n+                       r->ron[0] *= c; r->ron[1] *= c; r->ron[2] *= c;\n+               }\n                 r->rod = -DOT(r->rdir, r->ron);\n                 r->pert[0] = r->pert[1] = r->pert[2] = 0.0;\n                 r->uv[0] = r->uv[1] = 0.0;\n___\n<sup>Automatically generated content from [radiance mailing-list](https://radiance-online.org/pipermail/radiance-dev/2004-June/000370.html).</sup>", "attachments": [], "created_by_name": "Greg Ward", "created_at": "June 28, 2004 at 12:11PM", "created_by": "Greg_Ward", "parent_id": "radiance-dev_000364", "id": "radiance-dev_000370"}