{"body": "Hello Marcin,\n\n\nI am struggling a little bit with the language barrier, but I'm going  \nto assume you don't wish to continue the previous discussion, and are  \ninstead focused on modifying rayparticipate to model the formula you  \ngive below.  I won't ask why you want it, but here are the changes to  \nget you there:\n\n\nextern void\nrayparticipate(            /* compute ray medium participation */\n     register RAY  *r\n)\n{\n     COLOR    ce, ca;\n     double    re, ge, be;\n     double    rv, gv, bv;\n\t\t/* modified to return: L(s)+[L(0)-L(s)]*[1-exp(-ext*s)] */\n\t\t/* not that this equals: L(0)*exp(-ext*s)+[L(0)-L(0)*exp(-ext*s)]* \n[1-exp(-ext*s)] */\n\t\t/* which reduces to: L(0)*[1 - exp(-ext*s) + exp(-2*ext*s)] */\n     if (intens(r->cext) <= 1./FHUGE)\n         return;                /* no medium */\n     re = r->rot*colval(r->cext,RED);\n     ge = r->rot*colval(r->cext,GRN);\n     be = r->rot*colval(r->cext,BLU);\n     if (r->crtype & SHADOW) {        /* no scattering for sources */\n         re *= 1. - colval(r->albedo,RED);\n         ge *= 1. - colval(r->albedo,GRN);\n         be *= 1. - colval(r->albedo,BLU);\n     }\n\trv = 1. - (re<=FTINY ? 1. : re>92. ? 0. : exp(-re)) +\n\t\t\t(re<=FTINY ? 1. : re>46. ? 0. : exp(-2.*re));\n\tgv = 1. - (ge<=FTINY ? 1. : ge>92. ? 0. : exp(-ge)) +\n\t\t\t(ge<=FTINY ? 1. : ge>46. ? 0. : exp(-2.*ge));\n\tbv = 1. - (be<=FTINY ? 1. : be>92. ? 0. : exp(-be)) +\n\t\t\t(be<=FTINY ? 1. : be>46. ? 0. : exp(-2.*rebe);\n     setcolor(ce, rv, gv, bv);\n     multcolor(r->rcol, ce);            /* path extinction */\n     if (r->crtype & SHADOW || intens(r->albedo) <= FTINY)\n         return;                /* no scattering */\n     setcolor(ca,\n    \tcolval(r->albedo,RED)*colval(ambval,RED)*(1.-colval(ce,RED)),\n     \tcolval(r->albedo,GRN)*colval(ambval,GRN)*(1.-colval(ce,GRN)),\n     \tcolval(r->albedo,BLU)*colval(ambval,BLU)*(1.-colval(ce,BLU)));\n     addcolor(r->rcol, ca);            /* ambient in scattering */\n     srcscatter(r);                /* source in scattering */\n}\n\n\nHope this is useful.\n-Greg\n___\n<sup>Automatically generated content from [radiance mailing-list](https://radiance-online.org/pipermail/radiance-general/2008-April/004955.html).</sup>", "attachments": [], "created_by_name": "Greg Ward", "created_at": "April 25, 2008 at 09:08PM", "created_by": "Greg_Ward", "parent_id": "radiance-general_004888", "id": "radiance-general_004955"}