{"body": "Hey Jack, thanks for this. Good stuff. I am hoping to refactor the mess that is DaylightSim.rb this quarter, to make it more easily maintainable, and one of the things I plan to do at that time is also improve on this gendaylit error handling business!\n\n\nRob Guglielmetti\nNational Renewable Energy Laboratory (NREL)\nCommercial Buildings Research Group\n15013 Denver West Parkway MS:RSF202\nGolden, CO 80401\n303.275.4319\nrobert.guglielmetti at nrel.gov\n\n\n\n\n\n\nOn 10/17/12 12:29 PM, \"Jack de Valpine\" <jedev at visarc.com<mailto:jedev at visarc.com>> wrote:\n\n\nHi Tim,\n\n\nI sent this out earlier and I do not know why it did not get through (perhaps the mail server is choking on my sig). Here is my earlier response to Rob's follow-up. In short you might look at adjusting the time value by +/- 15 minutes.\n\n\n-Jack de Valpine\n\n\nHey Rob,\n\n\nJust to fill in the details a bit more now. I am largely working from Axel's observations on under what circumstances gendaylit fails. From what I have seen the error conditions are:\n\n\n 1.  if the Diffuse Normal Radiation is 0, in which case assume a night time step\n 2.  if the time used results in a solar zenith angle > 90 - this seems to occur at the boundary conditions around sunrise/sunset - this will report an error\n 3.  if the -W parameters are out of bounds for what gendaylit expects at a given time step - this looks like it seg faults\n\n\nTo process the weather data, I have been setting the time at 30 minutes less than the hour reported in the weather file. It occurs to me that in the case of (2) it might make sense to continue testing with altered times until a value is reported (just thinking off the cuff here). So for example (in condensed form):\n\n\nThe weather file for Boston reports the following for January 1 at 17:00\n\n\ndirect normal irradiance: 7\ndiffuse horizontal irradiance: 5\nif we do:\ngendaylit 1 1 16.5 -a 42.37 -o 71.02 -m 75 -W 7 5\n\n\nwe will get an error relating to zenith angle > 90\nhowever if we then move back 15 minutes:\ngendaylit 1 1 16.25 -a 42.37 -o 71.02 -m 75 -W 7 5\nwe actually get a valid description...\n\n\nCuriously adding 15 minutes to the time step in Tim's case actually results in a sky description:\ngendaylit 7 19 14.500 -W 924 65 -a 34.3 -o 116.17 -m 120\nresults in seg fault\n\n\ngendaylit 7 19 14.2500 -W 924 65 -a 34.3 -o 116.17 -m 120\nresults in error message:\nsky clearness or sky brightness out of range 12.605739     0.059480\n\n\ngendaylit 7 19 14.7500 -W 924 65 -a 34.3 -o 116.17 -m 120\nresults in sky description\nNote I am picking 15 minutes as the next increment as halving of the 30 minute value.\n\n\nNot really sure what this tells us or how it helps.... It is also not clear to me any issues that might result, eg pros/cons of:\n\n\n 1.  gendaylit initially fails so we fall back on gensky\n 2.  gendaylit initially fails so we use a different time value (within the hour of record) to get \"good\" output\n 3.  gendaylit initially fails so we fall back on the previous hour's value output\n\n\n-Jack\n\n\n\n\nOn 10/17/2012 2:18 PM, Tim Perry wrote:\n\n\nThank you, everyone, for the information. It sounds like gendaylit\njust can't handle some of the sky params and I need to enhance my\nscripts a bit. I imagine I'll be following Rob's lead. Or perhaps I'll\njust use his scripts.\n\n\nIn that short run, what if I just adjust the diffuse value up from 65\nto 65.07. Then I get a valid sky. The change is only 0.1%. Should I\nreduce the direct to compensate? Or just not worry about it?\n\n\nThanks,\nTim\n\n\nOn Wed, Oct 17, 2012 at 7:41 AM, Guglielmetti, Robert\n<Robert.Guglielmetti at nrel.gov><mailto:Robert.Guglielmetti at nrel.gov> wrote:\n\n\n\n\nOn 10/16/12 7:56 PM, \"Jack de Valpine\" <jedev at visarc.com<mailto:jedev at visarc.com><mailto:jedev at visarc.com><mailto:jedev at visarc.com>> wrote:\n\n\nHi Tim,\n\n\nI cannot test this right now, however I do know that it is possible for gendaylit to fail in select conditions. If I recall correctly, one is if the direct normal radiance is zero (not the case here). There are other cases where it fails more dramatically, which is what you are facing I believe. In this case I think that the thing to do is re-use a previous value from the data set (eg the previous hour).\n\n\nUnfortunately, what you really need to do is actually \"test\" if gendaylit is going to produce valid output prior to actually getting the output. This can be done by evaluating the result of:\ngendaylit $myArgs > /dev/null  2>&1\n\n\nwhich in your case would be\n\n\ngendaylit 7 19 14.500 -W 924 65 -a 34.3 -o 116.17 -m 120 > /dev/null 2>&1\n\n\nAssuming your are processing a complete weather file then you need to test every time step that is not definitively at night, so that you can catch any time steps that case an error for gendaylit and then do something in those places.\n\n\nThis has been a constant headache for us as well, as we are trying to use gendaylit in the OpenStudio annual simulation stuff. We do a test like Jack has illustrated above, again cribbing from Axel's excellent tutorials. We have found that bad sky descriptions can still be written (or nothing), and our test can miss some. The error reporting in gendaylit seems inconsistent. We try to scan for all the warnings/errors we have seen coming from gendaylit like so:\n\n\ngendaylit_command = \"gendaylit -ang #{tsSolarAlt} #{tsSolarAzi} -L #{tsDirectNormIllum} #{tsDiffuseHorIllum} 2>&1\"\n            tempIO = IO.popen(gendaylit_command)\n            gendaylit_output = tempIO.readlines.to_s\n            tempIO.close\n\n\n            tempSky = true\n            if /[wW]arning/.match(gendaylit_output) or /[eE]rror/.match(gendaylit_output) or /valid/.match(gendaylit_output) or /[cC]heck/.match(gendaylit_output) or /skyclearness/.match(gendaylit_output)\n              tempSky = false\n            End\n\n\n\u2026we fall back on gensky if found. Andy McNeil proposes scanning for a really tiny file (one of the failure modes for gendaylit is it writes a blank file with no errors generated). I implemented that in Ruby with the tempfile class, but obviously I did a poor job because the tempfiles were not being properly killed, so I took that out for now. But I do need to beef up this error checking as we'd prefer to use gendaylit.\n\n\n- Rob\n\n\n_______________________________________________\nRadiance-dev mailing list\nRadiance-dev at radiance-online.org<mailto:Radiance-dev at radiance-online.org>http://www.radiance-online.org/mailman/listinfo/radiance-dev\n\n\n_______________________________________________\nRadiance-dev mailing list\nRadiance-dev at radiance-online.org<mailto:Radiance-dev at radiance-online.org>http://www.radiance-online.org/mailman/listinfo/radiance-dev\n___\n<sup>Automatically generated content from [radiance mailing-list](https://radiance-online.org/pipermail/radiance-dev/2012-October/001265.html).</sup>", "attachments": [], "created_by_name": "Rob Guglielmetti", "created_at": "October 17, 2012 at 11:52AM", "created_by": "Rob_Guglielmetti", "parent_id": "radiance-dev_001258", "id": "radiance-dev_001265"}